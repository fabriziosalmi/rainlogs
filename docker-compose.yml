---
# docker-compose.yml – RainLogs production-like stack
# All data persisted in named volumes.
# Garage (S3-compatible) is used as the primary object store.
#
# Usage:
#   docker compose up -d
#   docker compose logs -f api

version: "3.9"

services:
  # ──────────────────────────────────────────────────────────────────────
  # Traefik - Reverse Proxy (NIS2 Compliance: HTTPS by default)
  # ──────────────────────────────────────────────────────────────────────
  traefik:
    image: traefik:v2.10
    restart: unless-stopped
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # Global HTTP -> HTTPS redirect
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      # Certificate Resolver (Let's Encrypt - HTTP Challenge)
      # Uncomment and configure email in command or env vars for production
      # - "--certificatesresolvers.myresolver.acme.httpchallenge=true"
      # - "--certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web"
      # - "--certificatesresolvers.myresolver.acme.email=postmaster@example.com"
      # - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
      # Traefik Dashboard (Localhost only)
      - "127.0.0.1:8081:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "traefik_data:/letsencrypt"

  # ──────────────────────────────────────────────────────────────────────
  # PostgreSQL 16 – metadata, customers, zones, log job records
  # ──────────────────────────────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-rainlogs}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      POSTGRES_DB: ${POSTGRES_DB:-rainlogs}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U rainlogs"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ──────────────────────────────────────────────────────────────────────
  # Redis 7 – asynq job queue + scheduler
  # ──────────────────────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-changeme}
    volumes:
      - redis_data:/data
    ports:
      - "127.0.0.1:6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-changeme}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ──────────────────────────────────────────────────────────────────────
  # Garage – S3-compatible object storage (EU-sovereign)
  # Swap this out for Hetzner / Contabo S3 in prod.
  # ──────────────────────────────────────────────────────────────────────
  garage:
    image: dxflrs/garage:v1.0.1
    restart: unless-stopped
    environment:
      GARAGE_RPC_SECRET: ${GARAGE_RPC_SECRET:-0000000000000000000000000000000000000000000000000000000000000000}
    volumes:
      - garage_data:/var/lib/garage/data
      - garage_meta:/var/lib/garage/meta
      - ./docker/garage/garage.toml:/etc/garage.toml:ro
    ports:
      - "127.0.0.1:3900:3900"  # S3 API
      - "127.0.0.1:3903:3903"  # admin
    healthcheck:
      test: ["CMD", "/garage", "status"]
      interval: 15s
      timeout: 5s
      retries: 5

  garage-init:
    image: alpine:latest
    depends_on:
      garage:
        condition: service_healthy
    volumes:
      - ./docker/garage/init.sh:/init.sh:ro
    command: sh -c "apk add --no-cache curl jq && /init.sh"

  # ──────────────────────────────────────────────────────────────────────
  # DB migration runner (runs once, then exits)
  # ──────────────────────────────────────────────────────────────────────
  migrate:
    image: migrate/migrate:v4.17.0
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./migrations:/migrations:ro
    command: >
      -path=/migrations
      -database "postgres://${POSTGRES_USER:-rainlogs}:${POSTGRES_PASSWORD:-changeme}@postgres:5432/${POSTGRES_DB:-rainlogs}?sslmode=disable"
      up
    restart: "no"

  # ──────────────────────────────────────────────────────────────────────
  # RainLogs API server
  # ──────────────────────────────────────────────────────────────────────
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: api
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      garage:
        condition: service_healthy
      garage-init:
        condition: service_completed_successfully
      migrate:
        condition: service_completed_successfully
    environment:
      RAINLOGS_APP_ENV: production
      RAINLOGS_APP_PORT: "8080"
      RAINLOGS_DATABASE_DSN: postgres://${POSTGRES_USER:-rainlogs}:${POSTGRES_PASSWORD:-changeme}@postgres:5432/${POSTGRES_DB:-rainlogs}?pool_max_conns=25
      RAINLOGS_REDIS_ADDR: redis://:${REDIS_PASSWORD:-changeme}@redis:6379/0
      RAINLOGS_REDIS_PASSWORD: ${REDIS_PASSWORD:-changeme}
      RAINLOGS_S3_ENDPOINT: ${S3_ENDPOINT:-http://garage:3900}
      RAINLOGS_S3_REGION: ${S3_REGION:-garage}
      RAINLOGS_S3_BUCKET: ${S3_BUCKET:-rainlogs-logs}
      RAINLOGS_S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID:-GK4b3b58b73f01eadbc80e2d59}
      RAINLOGS_S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY:-e528348beba2f13f5eae2632a4ff824d853fefae8c3423c1f16174e307b09d70}
      RAINLOGS_S3_FORCE_PATH_STYLE: "true"
      RAINLOGS_STORAGE_BACKEND: ${STORAGE_BACKEND:-s3}
      RAINLOGS_STORAGE_FS_ROOT: ${STORAGE_FS_ROOT:-/data}
      RAINLOGS_JWT_SECRET: ${JWT_SECRET:-0123456789abcdef0123456789abcdef}
      RAINLOGS_KMS_KEY: ${KMS_KEY:-0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef}
    ports:
      - "127.0.0.1:8080:8080"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.rainlogs.rule=Host(`${DOMAIN:-localhost}`)"
      - "traefik.http.routers.rainlogs.entrypoints=websecure"
      - "traefik.http.routers.rainlogs.tls=true"
      # Use internal service port
      - "traefik.http.services.rainlogs.loadbalancer.server.port=8080"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/health"]
      interval: 15s
      timeout: 5s
      retries: 5

  # ──────────────────────────────────────────────────────────────────────
  # RainLogs Worker
  # ──────────────────────────────────────────────────────────────────────
  worker:
    build:
      context: .
      dockerfile: Dockerfile
      target: worker
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      garage:
        condition: service_healthy
      garage-init:
        condition: service_completed_successfully
      migrate:
        condition: service_completed_successfully
    environment:
      RAINLOGS_APP_ENV: production
      RAINLOGS_DATABASE_DSN: postgres://${POSTGRES_USER:-rainlogs}:${POSTGRES_PASSWORD:-changeme}@postgres:5432/${POSTGRES_DB:-rainlogs}?pool_max_conns=10
      RAINLOGS_REDIS_ADDR: redis://:${REDIS_PASSWORD:-changeme}@redis:6379/0
      RAINLOGS_REDIS_PASSWORD: ${REDIS_PASSWORD:-changeme}
      RAINLOGS_S3_ENDPOINT: ${S3_ENDPOINT:-http://garage:3900}
      RAINLOGS_S3_REGION: ${S3_REGION:-garage}
      RAINLOGS_S3_BUCKET: ${S3_BUCKET:-rainlogs-logs}
      RAINLOGS_S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID:-GK4b3b58b73f01eadbc80e2d59}
      RAINLOGS_S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY:-e528348beba2f13f5eae2632a4ff824d853fefae8c3423c1f16174e307b09d70}
      RAINLOGS_S3_FORCE_PATH_STYLE: "true"
      RAINLOGS_STORAGE_BACKEND: ${STORAGE_BACKEND:-s3}
      RAINLOGS_STORAGE_FS_ROOT: ${STORAGE_FS_ROOT:-/data}
      RAINLOGS_KMS_KEY: ${KMS_KEY:-0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef}
      RAINLOGS_WORKER_CONCURRENCY: "10"
      RAINLOGS_WORKER_SCHEDULER_INTERVAL: "5m"
      RAINLOGS_WORKER_LOG_RETENTION_DAYS: "395"
    volumes:
      - logs_data:/data

  # ──────────────────────────────────────────────────────────────────────
  # Asynqmon – real-time queue monitoring UI
  # ──────────────────────────────────────────────────────────────────────
  asynqmon:
    image: hibiken/asynqmon:latest
    platform: linux/amd64
    restart: unless-stopped
    environment:
      REDIS_ADDR: redis:6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-changeme}
    ports:
      - "127.0.0.1:8383:8080"
    depends_on:
      - redis

volumes:
  traefik_data:
  postgres_data:
  redis_data:
  garage_data:
  garage_meta:
  logs_data:
